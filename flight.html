<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>機票價格獵人</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Custom Gradients */
        .bg-gradient-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); }
        
        /* Custom Select Style */
        select {
            background-image: none; /* Remove default arrow */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen overflow-hidden flex items-center justify-center sm:py-8">

<div id="app" class="w-full h-full sm:max-w-[414px] sm:h-[850px] sm:max-h-[90vh] bg-slate-50 relative flex flex-col sm:rounded-[40px] sm:shadow-2xl sm:border-[8px] sm:border-slate-800 overflow-hidden ring-1 ring-slate-900/5">

    <!-- Header -->
    <header class="bg-slate-900 text-white pt-10 pb-6 px-6 shadow-md flex justify-between items-center z-10 flex-shrink-0">
        <div>
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa-solid fa-plane-lock mr-2 text-emerald-400"></i> 機票價格獵人
            </h1>
            <p class="text-slate-400 text-xs mt-1 flex items-center">
                <span class="w-2 h-2 rounded-full mr-1.5" :class="n8nConfigured ? 'bg-emerald-400' : 'bg-red-400'"></span>
                {{ n8nConfigured ? '智慧分析已連線' : '離線模式' }}
            </p>
        </div>
        <div class="flex space-x-2">
            <div class="bg-emerald-500 text-white p-2 rounded-full cursor-pointer hover:bg-emerald-600 transition w-8 h-8 flex items-center justify-center" @click="openAddModal">
                <i class="fa-solid fa-plus text-sm"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 pb-24">
        
        <div v-if="flights.length === 0" class="flex flex-col items-center justify-center mt-20 text-slate-400">
            <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl">
                <i class="fa-solid fa-plane-up text-slate-300"></i>
            </div>
            <p>尚未追蹤任何航線</p>
            <button @click="openAddModal" class="mt-4 text-emerald-600 font-bold hover:underline">新增第一筆追蹤</button>
        </div>

        <div v-for="flight in flights" :key="flight.id" class="bg-gradient-card p-5 rounded-2xl shadow-sm border border-slate-200 relative group">
            <button @click.stop="deleteFlight(flight.id)" class="absolute top-4 right-4 text-slate-300 hover:text-red-400 transition p-2">
                <i class="fa-solid fa-trash"></i>
            </button>

            <!-- Route Info -->
            <div class="flex items-center mb-4">
                <div class="bg-slate-900 text-white font-mono font-bold px-3 py-1 rounded-lg text-sm mr-3 border border-slate-800 shadow-sm flex items-center">
                    {{ flight.dep }} 
                    <i class="fa-solid fa-arrow-right mx-2 text-xs text-emerald-400"></i> 
                    {{ flight.arr }}
                </div>
                <div class="text-sm font-bold text-slate-700">
                    {{ formatDate(flight.date) }}
                    <span v-if="flight.returnDate" class="text-xs text-slate-400 font-normal">~ {{ formatDate(flight.returnDate) }}</span>
                </div>
            </div>

            <!-- Price & Actions -->
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">目標價格</p>
                    <p class="text-lg font-bold text-slate-800">
                        <span class="text-xs text-slate-400 mr-0.5">NT$</span>{{ flight.targetPrice.toLocaleString() }}
                    </p>
                </div>
                
                <div class="flex space-x-2">
                    <!-- Analysis Button -->
                    <button v-if="n8nConfigured" @click="viewHistory(flight)" class="bg-white text-emerald-600 border border-emerald-200 px-3 py-2 rounded-xl flex items-center justify-center hover:bg-emerald-50 transition shadow-sm text-xs font-bold">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1.5"></i> 分析
                    </button>
                    
                    <button @click="openEditModal(flight)" class="bg-white border border-slate-200 text-slate-500 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-slate-50 transition">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    
                    <a :href="getGoogleFlightsUrl(flight)" target="_blank" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-black active:scale-95 transition flex items-center">
                        <i class="fa-brands fa-google mr-2"></i> 查價
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Add/Edit Flight -->
    <transition name="slide-up">
    <div v-if="showModal" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center" @click.self="showModal = false">
        <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pb-safe shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-6">{{ isEditing ? '編輯追蹤設定' : '新增追蹤' }}</h3>
            <div class="space-y-4">
                <!-- Modified: Dropdown Selectors for Airports -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">出發地</label>
                        <div class="relative">
                            <select v-model="form.dep" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none text-sm">
                                <option value="" disabled>請選擇</option>
                                <optgroup label="台灣">
                                    <option v-for="apt in airports.TW" :key="apt.code" :value="apt.code">{{ apt.name }} ({{ apt.code }})</option>
                                </optgroup>
                                <optgroup label="日本">
                                    <option v-for="apt in airports.JP" :key="apt.code" :value="apt.code">{{ apt.name }} ({{ apt.code }})</option>
                                </optgroup>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">目的地</label>
                        <div class="relative">
                            <select v-model="form.arr" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none text-sm">
                                <option value="" disabled>請選擇</option>
                                <optgroup label="日本">
                                    <option v-for="apt in airports.JP" :key="apt.code" :value="apt.code">{{ apt.name }} ({{ apt.code }})</option>
                                </optgroup>
                                <optgroup label="台灣">
                                    <option v-for="apt in airports.TW" :key="apt.code" :value="apt.code">{{ apt.name }} ({{ apt.code }})</option>
                                </optgroup>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">去程日期</label>
                    <input 
                        v-model="form.date" 
                        :type="(dateFocus || form.date) ? 'date' : 'text'"
                        placeholder="年/月/日" 
                        @focus="dateFocus = true"
                        @blur="dateFocus = false"
                        :min="minDate" 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                    >
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">回程日期 (選填)</label>
                    <input 
                        v-model="form.returnDate" 
                        :type="(returnDateFocus || form.returnDate) ? 'date' : 'text'"
                        placeholder="年/月/日" 
                        @focus="returnDateFocus = true"
                        @blur="returnDateFocus = false"
                        :min="form.date || minDate" 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                    >
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">目標價格 (NT$)</label>
                    <input v-model.number="form.targetPrice" type="number" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <button @click="saveFlight" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-emerald-600 active:scale-95 transition mt-2">
                    {{ isEditing ? '儲存修改' : '開始追蹤' }}
                </button>
            </div>
        </div>
    </div>
    </transition>

    <!-- Modal: Analysis & History Chart -->
    <transition name="fade">
    <div v-if="showHistory" class="absolute inset-0 bg-white z-50 flex flex-col">
        <div class="px-6 pt-10 pb-4 flex justify-between items-center bg-white border-b border-slate-100">
            <div>
                <h3 class="text-xl font-bold text-slate-800">價格分析報告</h3>
                <p class="text-xs text-slate-400 font-mono mt-0.5">{{ selectedFlight?.dep }} <i class="fa-solid fa-arrow-right mx-1"></i> {{ selectedFlight?.arr }}</p>
            </div>
            <button @click="closeHistory" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="flex-1 p-4 relative overflow-y-auto">
            <!-- Loading State -->
            <div v-if="loadingHistory" class="flex flex-col items-center justify-center h-64">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500 mb-4"></div>
                <p class="text-sm text-slate-400">正在生成分析報告...</p>
            </div>

            <!-- Error State -->
            <div v-else-if="historyError" class="flex flex-col items-center justify-center h-64 text-center px-8">
                <i class="fa-solid fa-triangle-exclamation text-amber-400 text-4xl mb-3"></i>
                <p class="text-slate-600 font-bold mb-1">無法取得資料</p>
                <p class="text-xs text-slate-400">{{ historyError }}</p>
            </div>

            <!-- Content -->
            <div v-else>
                <!-- AI Insight Card -->
                <div class="bg-emerald-50 rounded-2xl p-5 border border-emerald-100 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-emerald-100 rounded-full blur-2xl"></div>
                    
                    <h4 class="text-sm font-bold text-emerald-800 mb-3 flex items-center relative z-10">
                        <i class="fa-solid fa-robot mr-2"></i> 購票建議
                    </h4>
                    
                    <div class="text-sm text-emerald-900 leading-relaxed relative z-10">
                        目前最低價 <span class="font-bold text-lg mx-1">${{ latestPrice?.toLocaleString() }}</span> 
                        <span v-if="latestPrice <= selectedFlight.targetPrice" class="font-bold">低於您的目標！</span>
                        <span v-else>略高於目標。</span>
                        <br><br>
                        <span class="text-xs opacity-80">{{ generateAdvice(latestPrice, priceMin, priceMax) }}</span>
                    </div>
                </div>

                <!-- Quality Attributes -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <p class="text-[10px] text-slate-400 uppercase">價格區間 (30天)</p>
                        <p class="text-sm font-bold text-slate-700 mt-1">
                            ${{ priceMin?.toLocaleString() }} - ${{ priceMax?.toLocaleString() }}
                        </p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                        <p class="text-[10px] text-slate-400 uppercase">CP值評分</p>
                        <div class="flex justify-center items-center mt-1">
                            <i class="fa-solid fa-star text-amber-400 text-xs mr-1"></i>
                            <span class="text-sm font-bold text-slate-700">4.5</span>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="mb-2">
                    <h4 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">歷史價格走勢</h4>
                    <div class="h-48 w-full bg-white rounded-xl border border-slate-100 p-2">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                showModal: false,
                showHistory: false,
                loadingHistory: false,
                historyError: null,
                flights: [],
                settings: {
                    webhookGetUrl: 'https://ez2.zeabur.app/webhook-test/get-history'
                },
                form: { dep: 'TPE', arr: 'NRT', date: '', returnDate: '', targetPrice: 12000 },
                
                // Added: Airport Database
                airports: {
                    TW: [
                        { code: 'TPE', name: '台北 - 桃園' },
                        { code: 'TSA', name: '台北 - 松山' },
                        { code: 'KHH', name: '高雄 - 小港' }
                    ],
                    JP: [
                        { code: 'NRT', name: '東京 - 成田' },
                        { code: 'HND', name: '東京 - 羽田' },
                        { code: 'KIX', name: '大阪 - 關西' },
                        { code: 'CTS', name: '北海道 - 新千歲' },
                        { code: 'FUK', name: '福岡' },
                        { code: 'OKA', name: '沖繩 - 那霸' },
                        { code: 'NGO', name: '名古屋 - 中部' },
                        { code: 'SDJ', name: '仙台' },
                        { code: 'HKD', name: '函館' },
                        { code: 'AKJ', name: '旭川' }
                    ]
                },

                isEditing: false,
                editingId: null,
                selectedFlight: null,
                chartInstance: null,
                latestPrice: 0,
                priceMin: 0,
                priceMax: 0,
                minDate: new Date().toISOString().split('T')[0],
                dateFocus: false, 
                returnDateFocus: false 
            }
        },
        computed: {
            n8nConfigured() {
                return this.settings.webhookGetUrl && this.settings.webhookGetUrl.length > 0;
            }
        },
        mounted() {
            const savedFlights = localStorage.getItem('flightTrackerData');
            if (savedFlights) this.flights = JSON.parse(savedFlights);
            
            const savedSettings = localStorage.getItem('n8nSettings');
            if (savedSettings) {
                this.settings = JSON.parse(savedSettings);
                if(!this.settings.webhookGetUrl) this.settings.webhookGetUrl = 'https://ez2.zeabur.app/webhook-test/get-history';
            }
        },
        watch: {
            flights: { deep: true, handler() { localStorage.setItem('flightTrackerData', JSON.stringify(this.flights)); } },
            'form.date': function(newVal) {
                if (this.form.returnDate && newVal > this.form.returnDate) {
                    this.form.returnDate = newVal;
                }
            }
        },
        methods: {
            openAddModal() {
                this.isEditing = false;
                this.editingId = null;
                // Default to TPE -> NRT
                this.form = { dep: 'TPE', arr: 'NRT', date: '', returnDate: '', targetPrice: 12000 };
                this.showModal = true;
            },
            openEditModal(flight) {
                this.isEditing = true;
                this.editingId = flight.id;
                this.form = { ...flight };
                this.showModal = true;
            },
            saveFlight() {
                if (!this.form.dep || !this.form.arr || !this.form.date) return alert('請填寫完整資訊');
                
                const flightData = {
                    dep: this.form.dep, // Already upper case from select value
                    arr: this.form.arr,
                    date: this.form.date,
                    returnDate: this.form.returnDate,
                    targetPrice: this.form.targetPrice
                };

                if (this.isEditing) {
                    const index = this.flights.findIndex(f => f.id === this.editingId);
                    if (index !== -1) this.flights[index] = { ...this.flights[index], ...flightData };
                } else {
                    this.flights.push({ id: Date.now(), ...flightData });
                }
                this.showModal = false;
            },
            deleteFlight(id) {
                if (confirm('確定刪除此追蹤項目？')) {
                    this.flights = this.flights.filter(f => f.id !== id);
                }
            },
            generateAdvice(current, min, max) {
                const range = max - min;
                const position = (current - min) / range; 
                if (position < 0.2) return "目前處於價格低點區間，是入手的好時機！";
                if (position < 0.5) return "價格適中，若行程確定可以考慮購買。";
                if (position < 0.8) return "價格偏高，建議再觀望是否有促銷。";
                return "目前價格處於高點，除非急需否則建議等待。";
            },
            async viewHistory(flight) {
                this.selectedFlight = flight;
                this.showHistory = true;
                this.loadingHistory = true;
                this.historyError = null;

                const urlObj = new URL(this.settings.webhookGetUrl);
                urlObj.searchParams.append('dep', (flight.dep || '').trim());
                urlObj.searchParams.append('arr', (flight.arr || '').trim());
                urlObj.searchParams.append('date', (flight.date || '').trim());
                if (flight.returnDate) {
                    urlObj.searchParams.append('return_date', flight.returnDate.trim());
                    urlObj.searchParams.append('type', '1'); 
                } else {
                    urlObj.searchParams.append('type', '2'); 
                }
                
                const targetUrl = urlObj.toString();
                let data = null;

                try {
                    const res = await fetch(targetUrl);
                    if (res.ok) {
                        data = await res.json();
                    } else {
                        throw new Error('Direct fetch failed');
                    }
                } catch (e1) {
                    try {
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                        const res = await fetch(proxyUrl);
                        if (res.ok) data = await res.json();
                    } catch (e2) {
                        try {
                             const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                             const res = await fetch(proxyUrl);
                             if (res.ok) {
                                 const json = await res.json();
                                 data = JSON.parse(json.contents);
                             }
                        } catch (e3) {
                            this.historyError = '無法連線。請檢查 n8n 設定。';
                        }
                    }
                }

                this.loadingHistory = false;

                if (data) {
                    let formattedData = [];
                    if (data.price_insights && data.price_insights.price_history) {
                        formattedData = data.price_insights.price_history.map(item => ({
                            check_date: item[0] * 1000, 
                            price: item[1]
                        }));
                    }
                    
                    if (formattedData.length > 0) {
                        formattedData.sort((a, b) => new Date(a.check_date) - new Date(b.check_date));
                        const prices = formattedData.map(d => d.price);
                        this.priceMin = Math.min(...prices);
                        this.priceMax = Math.max(...prices);
                        this.latestPrice = formattedData[formattedData.length - 1].price;
                        
                        this.renderChart(formattedData);
                    } else {
                        this.historyError = 'API 未回傳歷史價格數據。';
                    }
                } else if (!this.historyError) {
                     this.historyError = 'API 回傳空值或格式錯誤';
                }
            },
            renderChart(data) {
                this.$nextTick(() => {
                    const canvas = document.getElementById('priceChart');
                    if (!canvas) return;

                    if (this.chartInstance) this.chartInstance.destroy();
                    
                    this.chartInstance = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.check_date),
                            datasets: [{
                                label: '價格 (TWD)',
                                data: data.map(d => d.price),
                                borderColor: '#10b981', // Emerald-500
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4, 
                                fill: true,
                                pointRadius: 3, 
                                pointHitRadius: 10,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { intersect: false, mode: 'index' },
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const date = new Date(context[0].parsed.x);
                                            return `${date.getMonth() + 1}月${date.getDate()}日`;
                                        },
                                        label: function(context) {
                                            return 'NT$ ' + context.parsed.y.toLocaleString();
                                        }
                                    },
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleFont: { size: 12 },
                                    bodyFont: { size: 14, weight: 'bold' },
                                    padding: 10,
                                    cornerRadius: 8,
                                    displayColors: false
                                }
                            },
                            scales: {
                                x: { 
                                    type: 'time',
                                    time: { 
                                        unit: 'day',
                                        displayFormats: { day: 'M/d' }
                                    },
                                    grid: { display: false },
                                    ticks: { maxTicksLimit: 6, font: { size: 11 }, color: '#64748b' }
                                },
                                y: { 
                                    beginAtZero: false,
                                    grid: { borderDash: [4, 4], color: '#e2e8f0' },
                                    ticks: { 
                                        font: { size: 11 },
                                        color: '#64748b',
                                        callback: function(value) { return '$' + value/1000 + 'k'; }
                                    }
                                }
                            }
                        }
                    });
                });
            },
            closeHistory() {
                this.showHistory = false;
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                    this.chartInstance = null;
                }
            },
            getGoogleFlightsUrl(flight) {
                let query = `Flights to ${flight.arr} from ${flight.dep} on ${flight.date}`;
                if (flight.returnDate) query += ` through ${flight.returnDate}`;
                return `https://www.google.com/travel/flights?q=${encodeURIComponent(query)}&curr=TWD`;
            },
            formatDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
            }
        }
    }).mount('#app');
</script>
</body>
</html>